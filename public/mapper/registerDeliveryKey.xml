<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="registerDeliveryKey">
  <select id="registerDeliveryKey">
    SELECT  CAST(
              CONCAT( #{stoId},
                      'O',
                      date_format(now(), '%Y%m%d'),
                      LPAD( CONCAT( IFNULL( MAX( CAST( SUBSTR( dlvryNo, 15 ) AS unsigned ) ) , 0 ) + 1 ), 5, '0' )
                     ) AS char ) AS dlvryNo
      FROM  tb_deliveries
     WHERE  stoId = #{stoId}
       AND  date_format(dlvryRecvDt, '%Y%m%d') = date_format(now(), '%Y%m%d')
  </select>
</mapper>

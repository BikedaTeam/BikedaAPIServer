<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="delivery">
  <select id="realTimeDelivery">
    SELECT	dlvr.dlvryNo,
      			dlvr.stoBrcofcId,
      			IFNULL((
      			SELECT	branch.brcofcNm
      			  FROM	tb_branches AS branch
      			 WHERE	dlvr.stoBrcofcId = branch.brcofcId
      			),"") AS stoBrcofcNm,
      			dlvr.stoId,
      			IFNULL((
      			SELECT	store.stoMtlty
      			  FROM	tb_stores AS store
      			 WHERE	dlvr.stoId = store.stoId
      			),"") AS stoMtlty,
      			IFNULL((
      			SELECT	store.stoTelno
      			  FROM	tb_stores AS store
      			 WHERE	dlvr.stoId = store.stoId
      			),"") AS stoTelno,
      			dlvr.dlvryCusTelno,
      			dlvr.dlvryCusAdres,
      			dlvr.dlvryCusRoadAdres,
      			dlvr.dlvryCusDetlAdres,
      			dlvr.dlvryCusLa,
      			dlvr.dlvryCusLo,
      			dlvr.dlvryPaySeCd,
      			dlvr.dlvryFoodAmnt,
      			dlvr.dlvryAmnt,
      			dlvr.dlvryPickReqTm,
      			date_format(dlvr.dlvryRecvDt, "%Y%m%d%H%i%s") dlvryRecvDt,
      			date_format(dlvr.dlvryDsptcDt, "%Y%m%d%H%i%s") dlvryDsptcDt,
      			date_format(dlvr.dlvryPickDt, "%Y%m%d%H%i%s") dlvryPickDt,
      			date_format(dlvr.dlvryTcDt, "%Y%m%d%H%i%s") dlvryTcDt,
      			dlvr.dlvryDstnc,
      			dlvr.dlvryStateCd,
      			dlvr.dlvryReqCn,
      			dlvr.riderBrcofcId,
      			IFNULL((
      			SELECT	branch.brcofcNm
      			  FROM	tb_branches AS branch
      			 WHERE	dlvr.riderBrcofcId = branch.brcofcId
      			),"") AS riderBrcofcNm,
      			dlvr.riderId,
      			IFNULL((
      			SELECT	rider.riderNm
      			  FROM	tb_riders AS rider
      			 WHERE	dlvr.riderId = rider.riderId
      			),"") AS riderNm,
      			IFNULL((
      			SELECT	rider.riderCelno
      			  FROM	tb_riders AS rider
      			 WHERE	dlvr.riderId = rider.riderId
      			),"") AS riderCelno
      FROM	tb_deliveries AS dlvr
     WHERE  1 = 1
      <if test="stoBrcofcId != null and !stoBrcofcId.equal('')">
       AND  dlvr.stoBrcofcId = #{stoBrcofcId}
      </if>
      <if test="stoId != null and !stoId.equal('')">
       AND  dlvr.stoId = #{stoId}
      </if>
      <if test="riderBrcofcId != null and !riderBrcofcId.equal('')">
       AND  dlvr.riderBrcofcId = #{riderBrcofcId}
      </if>
      <if test="riderId != null and !riderId.equal('')">
       AND  dlvr.riderId = #{riderId}
      </if>
      <if test="dlvryRecvDtStd != null and !dlvryRecvDtStd.equal('')">
       AND  date_format(dlvr.dlvryRecvDt, "%Y%m%d%H%i%s") >= #{dlvryRecvDtStd}
      </if>
      <if test="dlvryRecvDtEnd != null and !dlvryRecvDtEnd.equal('')">
       AND  date_format(dlvr.dlvryRecvDt, "%Y%m%d%H%i%s") <= #{dlvryRecvDtEnd}
      </if>
      <if test="dlvryStateCd != null and !dlvryStateCd.equal('')">
       AND  dlvr.dlvryStateCd = #{dlvryStateCd}
      </if>
     ORDER
        BY  dlvr.dlvryRecvDt desc
  </select>
  <select id="realTimeDeliveryCount">
    SELECT  dlvryStateCd,
            COUNT(*) AS dlvryCnt
      FROM  tb_deliveries AS dlvr
     WHERE  1=1
    <if test="stoBrcofcId != null and !stoBrcofcId.equal('')">
       AND  dlvr.stoBrcofcId = #{stoBrcofcId}
    </if>
    <if test="riderBrcofcId != null and !riderBrcofcId.equal('')">
       AND  dlvr.riderBrcofcId = #{riderBrcofcId}
    </if>
    <if test="dlvryRecvDtStd != null and !dlvryRecvDtStd.equal('')">
       AND  date_format(dlvr.dlvryRecvDt, "%Y%m%d%H%i%s") <![CDATA[ >= ]]> #{dlvryRecvDtStd}
    </if>
    <if test="dlvryRecvDtEnd != null and !dlvryRecvDtEnd.equal('')">
       AND  date_format(dlvr.dlvryRecvDt, "%Y%m%d%H%i%s") <![CDATA[ <= ]]> #{dlvryRecvDtEnd}
    </if>
     GROUP
        BY  dlvryStateCd
  </select>
</mapper>
